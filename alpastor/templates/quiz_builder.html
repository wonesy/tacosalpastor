{% extends 'base_generic.html' %}

{% load static %}

{% block additional_links %}
    <link rel="stylesheet" href="{% static 'css/quiz_builder.css' %}">
    <script src="{% static 'js/quiz_builder.js' %}"></script>
{% endblock %}

{% block content %}

    <div class="quiz-canvas">
        <div class="quiz">
            <h1 class="quiz-title">Quiz Builder</h1>

            <div class="form-group">
                <label for="quizTitle">Quiz Title</label>
                <input type="text" class="form-control" id="quizTitle" aria-describedby="quizTitleHelp" placeholder="Enter quiz title">
            </div>

            <div id="question-canvas">
                <!-- This is to be filled in via javascript functions -->
            </div>

            <div style="text-align: center">
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#newQuestionModal" onclick="getExistingQuestionQueryset();">
                    Add Question
                </button>
            </div>

            <form id="quizBuilderForm" onsubmit="buildQuizJSON();" action="savenewquiz/" method="post">
                {% csrf_token %}
                <input type="hidden" id="json_quiz" name="json_quiz" value="">
                <input type="submit" value="Submit" />
            </form>

        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="newQuestionModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content container-fluid">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Choose Question</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body row flex-nowrap">
                    <div class="blank-questions-wrapper col-md-3 col-sm-3">
                        <h3>New Question</h3>
                        <form id="blank-question-form">
                            <input type="radio" name="blank-question-opt" value="None" checked> None<br>
                            <input type="radio" name="blank-question-opt" value="Essay" > Essay<br>
                            <input type="radio" name="blank-question-opt" value="Multiple Choice"> Multiple Choice<br>
                            <input type="radio" name="blank-question-opt" value="Checkbox (multiple correct answers)"> Checkbox<br>
                            <input type="radio" name="blank-question-opt" value="Numeric Scale (i.e 1-10)"> Numeric Scale<br>
                        </form>
                    </div>
                    <div class="dividing-bar"></div>
                    <div class="existing-questions-wrapper col-md col-12" tabindex="-1">
                        <h3>Existing Question</h3>
                        <div class="row search-question-wrapper">
                            <div class="search col-sm-4 col-md-4">
                                <!-- Example split danger button -->
                                <div class="btn-group">
                                    <button type="button" id="dropdownMenuButton" class="btn btn-info">Any</button>
                                    <button type="button" class="btn btn-info dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <span class="sr-only">Toggle Dropdown</span>
                                    </button>
                                    <div class="dropdown-menu">
                                        <a class="dropdown-item" href="#" onclick="updateDropdownValue('Any');">Any</a>
                                        <a class="dropdown-item" href="#" onclick="updateDropdownValue('Essay');">Essay</a>
                                        <a class="dropdown-item" href="#" onclick="updateDropdownValue('M.C.');">Multiple Choice</a>
                                        <a class="dropdown-item" href="#" onclick="updateDropdownValue('Checkbox');">Checkbox</a>
                                        <a class="dropdown-item" href="#" onclick="updateDropdownValue('Numeric');">Numeric Scale</a>
                                    </div>
                                </div>
                            </div>
                            <div class="search text-input col-md col-sm-12">
                                <input id="searchExistingQuestion" type="text" class="text-input form-control" placeholder="Search question">
                            </div>
                        </div>
                        <div class="existing-questions-results">
                            <div id="existingQuestionsResults" class="results-wrapper">
                                <!-- Add results via javascript function -->
                            </div>

                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="addExistingQuestions();">Add</button>
                </div>
            </div>
        </div>
    </div>

    <script type="application/javascript">

        $(".existing-questions-wrapper").focus(function () {
            refreshBlankQuestionRadio();
        });

        $('#searchExistingQuestion').keyup(function() {
            delay(getExistingQuestionQueryset(), 1000);
        });

        function updateDropdownValue(val) {
            btn = document.getElementById('dropdownMenuButton');
            btn.innerHTML = val;
            getExistingQuestionQueryset()();
        }

        // this is the element template for every new multiple-choice question that gets added to the DOM
        var multipleChoiceTemplate =
            "<div class='question-wrapper'>" +
                "<div class='card question'>" +
                    "<span class='question-label'>Question Content</span>" +
                    "<input type='text' name='content' class='form-control' maxlength='1023' required='true' id='id_content' value='{1}'>" +
                    "<span class='question-label'>Explanation</span>" +
                    "<input type='text' name='explanation' class='form-control' maxlength='1023' id='id_explanation' value='{2}'>" +
                    "<span class='question-label'>Randomize Options</span>" +
                    "<input type='checkbox' name='randomize' id='id_randomize' '{3}'>" +
                    "<input type='hidden' name='type' value='1' id='id_type'>" +
                    "<div class='card-body opt-canvas' id={0}></div>" +
                    "<button class='new-question-btn btn fa fa-plus' type='button' onclick='addMultipleChoiceOption({0});'>" +
                    "</button>" +
                "</div>" +
            "</div>";

        // Every time this is called, a new MC template will be added to the DOM and filled out accordingly
        function addMultipleChoiceQuestion(existingQuestion) {
            var questionCanvas = document.getElementById('question-canvas');

            var content = "";
            var explanation = "";
            var randomize = "";
            var optionLength = 0;

            if (existingQuestion !== undefined) {
                content = existingQuestion['content'];
                explanation = existingQuestion['explanation'];

                if (existingQuestion['randomize'] === true) {
                    randomize = "checked='true'";
                }

                optionLength = existingQuestion['multiplechoiceoption_set'].length;
            }

            var canvasID = getNewID();
            questionCanvas.innerHTML += multipleChoiceTemplate.format(canvasID, content, explanation, randomize);

            // loop through and all all options
            for (var i = 0; i < optionLength; i++) {
                console.log(existingQuestion['multiplechoiceoption_set'][i]);
                addMultipleChoiceOption(canvasID, existingQuestion['multiplechoiceoption_set'][i]);
            }
        }

        var multipleChoiceOptionTemplate =
            "<div class='row mc-opt-wrapper' id='mcOption{0}'>" +
                "<div class='col col-sm mc-opt-delete-sidebar'>" +
                    "<button class='btn btn-block h-100 w-100' type='button' onclick='deleteMCOption({1}, \"mcOption{0}\");'>" +
                        "<i class='fa fa-lg fa-trash-alt'></i>" +
                    "</button>" +
                "</div>" +
                "<div class='mc-opt-content col'>" +
                    "<input type='text' name='content' class='form-control' maxlength='1024' required='true' id='id_content' value='{2}'>" +
                "</div>" +
                "<div class='col col-sm mc-opt-correct-sidebar'>" +
                    "<button class='btn btn-block h-100 w-100 {3}' type='button' onclick='isCorrectToggle(this);'>" +
                        "<input type='hidden' name='is_correct' value='{4}' id='id_is_correct'>" +
                        "<i class='fa fa-lg fa-check-circle'></i>" +
                    "</button>" +
                "</div>" +
            "</div>";

        function addMultipleChoiceOption(optCanvasId, existingOption) {
            var optCanvas = document.getElementById(optCanvasId);

            var content = "";
            var isCorrect = false;
            var activeClass = "";

            if (existingOption !== undefined) {
                content = existingOption['content'];
                isCorrect = existingOption['is_correct'];

                if (isCorrect === true) {
                    activeClass = "active";
                }
            }

            console.log(multipleChoiceOptionTemplate.format(getNewID(), optCanvasId, content));
            optCanvas.innerHTML += multipleChoiceOptionTemplate.format(getNewID(), optCanvasId, content, activeClass, isCorrect);
        }

    </script>
{% endblock %}
