{% extends 'base_generic.html' %}

{% load static %}

{% block additional_links %}
    <link rel="stylesheet" href="{% static 'css/people.css' %}">

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.1.0/list.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>


{% endblock %}

{% block content %}
    <div id="users" class="container-fluid">
        <div class="search-bar">
            <input class="search" placeholder="Search student name"/>
            <button class="sort" data-sort="country">
                Sort by Country
            </button>
            <button class="sort" data-sort="intakesemester">
                Sort By Year
            </button>
            <button class="sort" data-sort="fullname">
                Sort By Name
            </button>
            <button class="csv" onClick="doCsv()">EXPORT to csv</button>
        </div>
        <div class="filters">
            <button class="accordion">Additional filters</button>
            <div class="panel">
                <div class="row">
                    <div class="col-4">
                        <p>Specialiaztion</p>
                        <div class="specializationContainer"></div>
                    </div>
                    <div class="col-4">
                        <p>Program</p>
                        <div class="programContainer"></div>
                    </div>
                    <div class="col-4">
                        <p>Intake semester</p>
                        <div class="semesterContainer"></div>
                    </div>
                </div>
            </div>
        </div>
        <br>
        <div class="people-table">
            <table class="space responsive-table" id="nT">
                <thead class="table-header">
                <tr>
                    <th>Photo</th>
                    <th>Name</th>
                    <th>Country</th>
                    <th>Status</th>
                    <th>Program</th>
                    <th>Specialization</th>
                    <th>Semester</th>
                    <th>Email</th>
                    <th>EPITA Email</th>
                    <th>Phone</th>
                </tr>
                </thead>
                <tbody class="list">
                {% for student in students %}
                    <tr class="table-row">
                        <td class="photo">
                            <div class="people-img"> {% if student.photo_location != "" %}
                                {% with 'image/portraits/'|add:student.photo_location as image_static %}
                                    <img class="center-block" src="{% static image_static %}"
                                         alt={{ student.first_name }}>
                                {% endwith %}
                            {% else %}
                                <img src="{% static 'image/portraits/generic_taco.jpg' %}" alt="Default taco"
                                     class="people-img">
                            {% endif %}
                            </div>

                        </td>
                        <td class="fullname"> {{ student.user.first_name }} {{ student.user.last_name }} </td>
                        <td class="country" style="text-align: center">{{ student.country }}
                            <div>
                                {% with 'image/flags/'|add:student.country_code|add:'.jpg' as image_static %}
                                    <img class="tile_image" src="{% static image_static %}"
                                         alt={{ student.first_name }}>
                                {% endwith %}
                            </div>
                        </td>
                        <td>{{ student.get_enrollment_status_display }}</td>
                        <td class="born">  {{ student.get_program_display }} </td>
                        <td class="name">
                            {{ student.get_specialization_display }}

                        </td>
                        <td class="intakesemester"> {{ student.intakeSemester }} </td>
                        <td class="email"> {{ student.user.email }} </td>
                        <td class="extemail">{{ student.user.external_email }} </td>
                        <td class="phone">{{ student.phone }}</td>
                    </tr>
                {% endfor %}

                </tbody>
            </table>
        </div>
        <ul class="pagination"></ul>
    </div>



    <script>
        let options = {
            valueNames: ['name', 'country', 'born', 'intakesemester', 'fullname'],
            page: 20,
            pagination: true
        };
        let userList = new List('users', options);


        let updateList = function () {
            let names = [];
            let dates = [];
            let semester = [];

            $("input:checkbox[name=names]:checked").each(function () {
                names.push($(this).val());
            });

            $("input:checkbox[name=dates]:checked").each(function () {
                dates.push($(this).val());
            });

            $("input:checkbox[name=semester]:checked").each(function () {
                semester.push($(this).val());
            });

            let values_date = dates.length > 0 ? dates : null;
            let values_name = names.length > 0 ? names : null;
            let values_semester = semester.length > 0 ? semester : null;


            userList.filter(function (item) {
                return (_(values_date).contains(item.values().born) || !values_date)
                    && (_(values_name).contains(item.values().name) || !values_name)
                    && (_(values_semester).contains(item.values().intakesemester) || !values_semester)
            });
        };

        $(document).off("change", "input:checkbox[name=dates]");
        $(document).on("change", "input:checkbox[name=dates]", updateList);
        $(document).off("change", "input:checkbox[name=names]");
        $(document).on("change", "input:checkbox[name=names]", updateList);
        $(document).off("change", "input:checkbox[name=semester]");
        $(document).on("change", "input:checkbox[name=semester]", updateList);

        $(function () {
            let all_born = [];
            let all_name = [];
            let all_intakesemester = [];

            updateList();
            _(userList.items).each(function (item) {
                all_born.push(item.values().born);
                all_name.push(item.values().name);
                all_intakesemester.push(item.values().intakesemester)
            });

            _(all_born).uniq().each(function (item) {
                $(".programContainer").append('<label><input type="checkbox" name="dates" value="' + item + '">' + item + '</label><br>')
            });

            _(all_name).uniq().each(function (item) {
                $(".specializationContainer").append('<label><input type="checkbox" name="names" value="' + item + '">' + item + '</label><br>')
            });

            _(all_intakesemester).uniq().each(function (item) {
                $(".semesterContainer").append('<label><input type="checkbox" name="semester" value="' + item + '">' + item + '</label><br>')
            });
        });

        let acc = document.getElementsByClassName("accordion");
        let i;

        for (i = 0; i < acc.length; i++) {
            acc[i].addEventListener("click", function () {
                this.classList.toggle("active");
                let panel = this.nextElementSibling;
                if (panel.style.display === "block") {
                    panel.style.display = "none";
                } else {
                    panel.style.display = "block";
                }
            });
        }



        function doCsv() {

            let nT = document.getElementById("nT").innerHTML;
            let dataa = nT.replace(/<thead([\w\W]+?)>/g, '')
                .replace(/<tbody([\w\W]+?)>/g, '')
                .replace(/<\/thead>/g, '')
                .replace(/<\/tbody>/g, '')
                .replace(/<tr([\w\W]+?)>/g, '')
                .replace(/<div([\w\W]+?)>/g, '')
                .replace(/<img([\w\W]+?)>/g, 'img')
                .replace(/<th>/g, '')
                .replace(/<\/th>/g, ',')
                .replace(/<td([\w\W]+?)>/g, '')
                .replace(/<\/td>/g, ',')
                .replace(/\s+/g, '')
                .replace(/<\n>/g, '')
                .replace(/<\/tr>/g, '\n')
                .replace(/<\/div>/g, '');

            let download = function (content, fileName, mimeType) {
                let a = document.createElement('a');
                mimeType = mimeType || 'application/octet-stream';

                if (navigator.msSaveBlob) { // IE10
                    navigator.msSaveBlob(new Blob([content], {
                        type: mimeType
                    }), fileName);
                } else if (URL && 'download' in a) { //html5 A[download]
                    a.href = URL.createObjectURL(new Blob([content], {
                        type: mimeType
                    }));
                    a.setAttribute('download', fileName);
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                } else {
                    location.href = 'data:application/octet-stream,' + encodeURIComponent(content); // only this mime type is supported
                }
            };

            download(dataa, 'Students.csv', 'text/csv;encoding:utf-8');
        }


    </script>


{% endblock %}